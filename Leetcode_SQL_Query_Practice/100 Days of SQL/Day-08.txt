Create table friend (pid int, fid int);
insert into friend (pid , fid ) values ('1','2');
insert into friend (pid , fid ) values ('1','3');
insert into friend (pid , fid ) values ('2','1');
insert into friend (pid , fid ) values ('2','3');
insert into friend (pid , fid ) values ('3','5');
insert into friend (pid , fid ) values ('4','2');
insert into friend (pid , fid ) values ('4','3');
insert into friend (pid , fid ) values ('4','5');

create table person (PersonID int,	Name varchar(50),	Score int);
insert into person(PersonID,Name ,Score) values('1','Alice','88');
insert into person(PersonID,Name ,Score) values('2','Bob','11');
insert into person(PersonID,Name ,Score) values('3','Devis','27');
insert into person(PersonID,Name ,Score) values('4','Tara','45');
insert into person(PersonID,Name ,Score) values('5','John','63');

select * from person;
select * from friend;


-- Query (My Solution)
with person_details
as
(
select b.pid,a.name,b.fid 
from person a 
inner join friend b 
on a.personid = b.pid
),
person_score_details as 
(
select a.pid,a.name,count(a.fid) as no_of_friends,sum(b.score) as total_friend_score 
from person_details a 
inner join person b 
on a.fid = b.personid 
group by a.pid,a.name
)
select pid,total_friend_score,no_of_friends,name as person_name from person_score_details
where total_friend_score>100
order by pid;

-- More optimized Version.

with person_score_details as (
    select 
        b.pid,
        a.name as person_name,
        count(b.fid) as no_of_friends,
        sum(p.score) as total_friend_score
    from person a
    inner join friend b on a.personid = b.pid
    inner join person p on b.fid = p.personid
    group by b.pid, a.name
)
select 
    pid,
    total_friend_score,
    no_of_friends,
    person_name
from person_score_details
where total_friend_score > 100
order by pid;