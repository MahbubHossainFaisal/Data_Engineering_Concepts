-- Find companies who have at least two users who speaks English and German both the languages.

create table company_users 
(
company_id int,
user_id int,
language varchar(20)
);

insert into company_users values (1,1,'English')
,(1,1,'German')
,(1,2,'English')
,(1,3,'German')
,(1,3,'English')
,(1,4,'English')
,(2,5,'English')
,(2,5,'German')
,(2,5,'Spanish')
,(2,6,'German')
,(2,6,'Spanish')
,(2,7,'English');

with more_than_1_user
as
(
select company_id,user_id,count(*) from company_users
group by company_id,user_id
having count(*) > 1
),
users_with_language_flag as
(
select mt.company_id,mt.user_id,cu.language,CASE WHEN cu.language = 'English' then 1 WHEN cu.language = 'German' then 2 else 0 end as lang_flag
from more_than_1_user mt 
inner join company_users cu 
on mt.company_id = cu.company_id
and mt.user_id = cu.user_id
where (CASE WHEN cu.language = 'English' then 1 WHEN cu.language = 'German' then 2 else 0 end) <> 0
),
users_who_speaks_both_lang as
(
select company_id,user_id,sum(lang_flag) as both_lang_num from users_with_language_flag
group by company_id,user_id
)
select company_id,count(distinct user_id) as user_count
from users_who_speaks_both_lang
where both_lang_num=3
group by company_id
having count(distinct user_id)>1;



-- Optimized solution 


WITH users_with_both AS (
    SELECT company_id, user_id
    FROM company_users
    WHERE language IN ('English', 'German')
    GROUP BY company_id, user_id
    HAVING COUNT(DISTINCT language) = 2
)
SELECT company_id,count(DISTINCT user_id) as user_count
FROM users_with_both
GROUP BY company_id
HAVING COUNT(*) >= 2;
