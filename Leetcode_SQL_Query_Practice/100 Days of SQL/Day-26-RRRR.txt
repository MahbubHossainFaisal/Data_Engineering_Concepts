-- 3 or more consecutive empty sits

create table bms (seat_no int ,is_empty varchar(10));
insert into bms values
(1,'N')
,(2,'Y')
,(3,'N')
,(4,'Y')
,(5,'Y')
,(6,'Y')
,(7,'N')
,(8,'Y')
,(9,'Y')
,(10,'Y')
,(11,'Y')
,(12,'N')
,(13,'Y')
,(14,'Y');

select * from bms;

-- multi lead, lag version

with consecutive_1 as
(
select seat_no,is_empty, lag(is_empty,1) OVER(ORDER BY seat_no) as prev1, lag(is_empty,2) over(order by seat_no) as prev2,
lead(is_empty,1) over(order by seat_no) as next1, lead(is_empty,2) over(order by seat_no) as next2
from bms
)
select * from consecutive_1
where (is_empty='Y' and prev1 = 'Y' and prev2='Y')
or 
(is_empty='Y' and next1='Y' and next2='Y')
or
(is_empty='Y' and prev1='Y' and next1='Y');

-- advance analytis function

with consecutive_2 as
(
select seat_no, is_empty, sum(case when is_empty='Y' then 1 else 0 end) OVER(order by seat_no rows between 2 preceding and current row) as prev_2,
sum(case when is_empty='Y' then 1 else 0 end) OVER(order by seat_no rows between 1 preceding and 1 following) as prev_curr_next,
sum(case when is_empty='Y' then 1 else 0 end) OVER(order by seat_no rows between current row and 2 following) as next_2
from bms
)
select * from consecutive_2
where prev_2 = 3 or prev_curr_next = 3 or next_2 = 3;




-- using ROW_NUMBER and arithmatic

with consecutive_3 as
(
select *, row_number() over(order by seat_no), seat_no - row_number() over(order by seat_no) as diff  from bms
where is_empty = 'Y'
),
cnt as
(
select diff, count(1) as diff_num from consecutive_3
group by diff
having count(1)>2
)
select * from consecutive_3 where diff in (select diff from cnt);


